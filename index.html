<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Permohonan Keluar Asrama - SMKA Baling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .view { transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
        .view.hidden { opacity: 0; transform: scale(0.98); pointer-events: none; position: absolute; width: 100%;}
        .input-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; }
        .action-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.375rem; font-weight: 500; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative">

        <header class="text-center mb-10">
            <img src="https://i.ibb.co/5hf6PqP9/smkab-T.png" alt="Logo SMKA Baling" class="w-24 h-24 mx-auto mb-4">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-900 uppercase">Sekolah Menengah Kebangsaan Agama Baling</h1>
            <p id="datetime" class="text-gray-600 mt-2 text-sm"></p>
        </header>

        <!-- ===== Bahagian Carian (View 1) ===== -->
        <div id="searchView" class="view">
            <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl mx-auto">
                <div class="text-center">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Sistem Permohonan Keluar Asrama/Pulang Bermalam</h1>
                    <p class="text-gray-600 mb-6">Sila masukkan Kod Waris anda untuk meneruskan.</p>
                </div>
                <form id="searchForm" class="flex flex-col sm:flex-row gap-3 mb-6">
                    <input type="text" id="kodWarisInput" placeholder="Masukkan Kod Waris..." class="flex-grow input-field">
                    <button type="submit" id="searchButton" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <span id="searchButtonText">Cari Maklumat</span>
                        <div id="loadingSpinner" class="hidden loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5" style="border-top-color: white;"></div>
                    </button>
                </form>
                <div id="statusContainer" class="text-center py-5"><p id="statusMessage" class="text-gray-500">Sila mulakan carian.</p></div>
            </div>
        </div>

        <!-- ===== Bahagian Paparan Maklumat (View 2) ===== -->
        <div id="resultsView" class="view hidden">
             <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Maklumat Anak Jagaan</h2>
                <form id="updateForm">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-700 mb-3">Butiran Murid</h3>
                            <div class="space-y-4 text-sm">
                                <div><p class="font-medium text-gray-500">Nama Anak</p><p id="namaAnakDisplay" class="text-lg font-semibold text-gray-800"></p><input type="text" id="namaAnakInput" class="input-field hidden"></div>
                                <div><p class="font-medium text-gray-500">Tingkatan</p><p id="tingkatanDisplay" class="text-lg font-semibold text-gray-800"></p><input type="text" id="tingkatanInput" class="input-field hidden"></div>
                                <div><p class="font-medium text-gray-500">Jantina</p><p id="jantinaDisplay" class="text-lg font-semibold text-gray-800"></p><input type="text" id="jantinaInput" class="input-field hidden"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-blue-700 mb-3">Butiran Waris</h3>
                            <div class="space-y-4 text-sm">
                                <div><p class="font-medium text-gray-500">Nama Waris</p><p id="namaWarisDisplay" class="text-base text-gray-800"></p><input type="text" id="namaWarisInput" class="input-field hidden"></div>
                                <div><p class="font-medium text-gray-500">Kod Waris</p><p id="kodWarisDisplay" class="text-base text-gray-800 font-mono"></p></div>
                                <div><p class="font-medium text-gray-500">Email</p><p id="emailDisplay" class="text-base text-gray-800"></p><input type="email" id="emailInput" class="input-field hidden"></div>
                                <div><p class="font-medium text-gray-500">No. Telefon</p><p id="noTelefonDisplay" class="text-base text-gray-800"></p><input type="tel" id="noTelefonInput" class="input-field hidden"></div>
                            </div>
                        </div>
                    </div>
                </form>

                <div id="historySection" class="mt-8">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">Sejarah Permohonan</h3>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tarikh Mohon</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tujuan</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="applicationHistoryBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <p id="noHistoryMessage" class="hidden text-center text-gray-500 py-4">Tiada sejarah permohonan ditemui.</p>
                </div>

                <div id="actionButtons" class="mt-8 flex flex-col sm:flex-row justify-center gap-3">
                    <button id="updateButton" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Kemaskini Maklumat</button>
                    <button id="newApplicationButton" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Permohonan Baru</button>
                </div>
                <div id="editButtons" class="hidden mt-8 flex flex-col sm:flex-row justify-center gap-3">
                    <button id="saveButton" type="submit" form="updateForm" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <span>Simpan Perubahan</span>
                        <div class="loader hidden ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5" style="border-top-color: white;"></div>
                    </button>
                    <button id="cancelButton" type="button" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Batal</button>
                </div>
                <div class="mt-4 text-center"><button id="backToSearchButton" class="text-sm text-gray-500 hover:underline">Â« Kembali ke Carian</button></div>
             </div>
        </div>

        <div id="applicationView" class="view hidden">
             <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl mx-auto">
                <h2 id="applicationTitle" class="text-2xl font-bold text-gray-900 mb-6 border-b pb-4">Borang Permohonan Keluar</h2>
                <form id="applicationForm">
                    <input type="hidden" id="appIdInput">
                    <div class="space-y-4">
                        <div><label class="font-medium text-gray-700">Nama Pemohon</label><input type="text" id="appNamaPemohon" class="input-field bg-gray-100" readonly></div>
                        <div><label class="font-medium text-gray-700">Nama Anak</label><input type="text" id="appNamaAnak" class="input-field bg-gray-100" readonly></div>
                        <div><label class="font-medium text-gray-700">Tujuan</label><textarea id="appTujuan" class="input-field" rows="3" required></textarea></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="font-medium text-gray-700">Tarikh Keluar</label><input type="date" id="appTarikhKeluar" class="input-field" required></div>
                            <div><label class="font-medium text-gray-700">Masa Keluar</label><input type="time" id="appMasaKeluar" class="input-field" required></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="font-medium text-gray-700">Tarikh Kembali</label><input type="date" id="appTarikhKembali" class="input-field" required></div>
                            <div><label class="font-medium text-gray-700">Masa Kembali</label><input type="time" id="appMasaKembali" class="input-field" required></div>
                        </div>
                        
                        <!-- MEDAN MUAT NAIK GAMBAR -->
                        <div>
                            <label class="font-medium text-gray-700">Muat Naik Bukti (Pilihan, < 5MB)</label>
                            <input type="file" id="appBukti" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                            <p id="filePreview" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                    </div>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-3">
                        <button id="appSubmitButton" type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                            <span id="appSubmitButtonText">Hantar Permohonan</span>
                            <div class="loader hidden ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5" style="border-top-color: white;"></div>
                        </button>
                        <button id="cancelApplicationButton" type="button" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Batal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzYJBLTB1XAaLd1kp0WK07MhKBwDK3ZzmTRcDeZec6jB4NW66mRVxttYKeaTbcZzR8OOQ/exec';

        const views = { search: document.getElementById('searchView'), results: document.getElementById('resultsView'), application: document.getElementById('applicationView') };
        const searchForm = document.getElementById('searchForm');
        const updateForm = document.getElementById('updateForm');
        const applicationForm = document.getElementById('applicationForm');
        const statusMessage = document.getElementById('statusMessage');
        const kodWarisInput = document.getElementById('kodWarisInput');
        const applicationHistoryBody = document.getElementById('applicationHistoryBody');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        
        let allDataCache = null;
        let currentItem = null;
        let selectedFile = null;

        function snakeToCamel(str) {
            return str.toLowerCase().replace(/([_][a-z])/g, group => group.toUpperCase().replace('_', ''));
        }

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
        }

        function setButtonLoading(button, isLoading, loadingText = 'Memproses...') {
            const textEl = button.querySelector('span');
            const spinnerEl = button.querySelector('.loader');
            if (button) button.disabled = isLoading;
            if (textEl) {
                if(isLoading) {
                    textEl.dataset.originalText = textEl.textContent;
                    textEl.textContent = loadingText;
                } else {
                    textEl.textContent = textEl.dataset.originalText || '';
                }
            }
             if (spinnerEl) {
                spinnerEl.classList.toggle('hidden', !isLoading);
            }
        }
        
        function setEditMode(isEditing) {
            updateForm.querySelectorAll('p[id$="Display"]').forEach(el => el.classList.toggle('hidden', isEditing));
            updateForm.querySelectorAll('input[id$="Input"]').forEach(el => el.classList.toggle('hidden', !isEditing));
            document.getElementById('actionButtons').classList.toggle('hidden', isEditing);
            document.getElementById('editButtons').classList.toggle('hidden', !isEditing);
            if (isEditing) {
                document.getElementById('namaAnakInput').value = currentItem.nama_anak;
                document.getElementById('tingkatanInput').value = currentItem.tingkatan;
                document.getElementById('jantinaInput').value = currentItem.jantina;
                document.getElementById('namaWarisInput').value = currentItem.nama_waris;
                document.getElementById('emailInput').value = currentItem.email;
                document.getElementById('noTelefonInput').value = currentItem.no_telefon;
            }
        }

        async function postData(payload) {
            await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            return { status: 'success' };
        }

        async function fetchData() {
            if (allDataCache) return allDataCache;
            statusMessage.textContent = 'Memuat turun data terkini...';
            const response = await fetch(WEB_APP_URL);
            if (!response.ok) throw new Error(`Ralat Rangkaian: ${response.status}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            allDataCache = result.data;
            return allDataCache;
        }

        function renderResults(item) {
            currentItem = item;
            Object.keys(item).forEach(key => {
                const camelCaseKey = snakeToCamel(key);
                const el = document.getElementById(camelCaseKey + 'Display');
                if (el) el.textContent = item[key] || '-';
            });
        }
        
        function getStatusBadge(status) {
            status = (status || '').toUpperCase();
            let classes = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full ';
            if (status === 'LULUS') return classes + 'bg-green-100 text-green-800';
            if (status === 'TOLAK' || status === 'DIBATALKAN') return classes + 'bg-red-100 text-red-800';
            return classes + 'bg-yellow-100 text-yellow-800';
        }

        function renderApplicationHistory(applications) {
            applicationHistoryBody.innerHTML = '';
            const sortedApps = applications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sortedApps.length === 0) {
                noHistoryMessage.classList.remove('hidden');
                applicationHistoryBody.closest('div.overflow-x-auto').classList.add('hidden');
            } else {
                noHistoryMessage.classList.add('hidden');
                applicationHistoryBody.closest('div.overflow-x-auto').classList.remove('hidden');
                sortedApps.forEach(app => {
                    const row = applicationHistoryBody.insertRow();
                    const formattedDate = new Date(app.timestamp).toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
                    let actionButtons = 'Tiada';
                    if ((app.status || '').toUpperCase() === 'BARU') {
                        actionButtons = `
                            <button class="action-btn bg-blue-100 text-blue-800 update-app-btn" data-id="${app.id_permohonan}">Kemaskini</button>
                        `;
                    }
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm text-gray-800">${app.tujuan || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm"><span class="${getStatusBadge(app.status)}">${app.status || 'N/A'}</span></td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm space-x-2">${actionButtons}</td>
                    `;
                });
            }
        }
        
        async function refreshDataAndView() {
            allDataCache = null;
            statusMessage.textContent = 'Memuat semula data...';
            try {
                const data = await fetchData();
                const foundItem = data.murid.find(item => item.kod_waris.toString() === currentItem.kod_waris.toString());
                if (foundItem) {
                    renderResults(foundItem);
                    const filteredApps = data.permohonan.filter(app => app.kod_waris.toString() === foundItem.kod_waris.toString());
                    renderApplicationHistory(filteredApps);
                }
            } catch (err) {
                statusMessage.textContent = `Gagal memuat semula: ${err.message}`;
            } finally {
                statusMessage.textContent = '';
            }
        }

        document.getElementById('appBukti').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5242880) { // 5MB
                    alert("Saiz fail terlalu besar. Sila pilih gambar di bawah 5MB.");
                    e.target.value = "";
                    selectedFile = null;
                    document.getElementById('filePreview').textContent = "";
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedFile = {
                        fileName: file.name,
                        mimeType: file.type,
                        fileData: event.target.result
                    };
                    document.getElementById('filePreview').textContent = `Fail dipilih: ${file.name}`;
                };
                reader.readAsDataURL(file);
            } else {
                selectedFile = null;
                document.getElementById('filePreview').textContent = '';
            }
        });

        applicationHistoryBody.addEventListener('click', async (e) => {
            const updateButton = e.target.closest('.update-app-btn');
            
            if (updateButton) {
                const appId = updateButton.dataset.id;
                const appToUpdate = allDataCache.permohonan.find(app => app.id_permohonan === appId);
                if (appToUpdate) {
                    document.getElementById('applicationTitle').textContent = 'Kemaskini Permohonan';
                    document.getElementById('appSubmitButtonText').textContent = 'Simpan Kemaskini';
                    document.getElementById('appIdInput').value = appToUpdate.id_permohonan;
                    document.getElementById('appNamaPemohon').value = currentItem.nama_waris;
                    document.getElementById('appNamaAnak').value = currentItem.nama_anak;
                    document.getElementById('appTujuan').value = appToUpdate.tujuan;
                    document.getElementById('appTarikhKeluar').value = new Date(appToUpdate.tarikh_keluar).toISOString().split('T')[0];
                    document.getElementById('appMasaKeluar').value = appToUpdate.masa_keluar;
                    document.getElementById('appTarikhKembali').value = new Date(appToUpdate.tarikh_kembali).toISOString().split('T')[0];
                    document.getElementById('appMasaKembali').value = appToUpdate.masa_kembali;
                    switchView('application');
                }
            }
        });

        document.getElementById('newApplicationButton').addEventListener('click', () => {
            document.getElementById('applicationTitle').textContent = 'Borang Permohonan Keluar';
            document.getElementById('appSubmitButtonText').textContent = 'Hantar Permohonan';
            applicationForm.reset(); 
            document.getElementById('appIdInput').value = '';
            document.getElementById('appNamaPemohon').value = currentItem.nama_waris;
            document.getElementById('appNamaAnak').value = currentItem.nama_anak;
            selectedFile = null;
            document.getElementById('filePreview').textContent = '';
            switchView('application');
        });
        
        applicationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const appSubmitButton = document.getElementById('appSubmitButton');
            setButtonLoading(appSubmitButton, true, 'Menghantar...');

            const appId = document.getElementById('appIdInput').value;
            const isUpdate = !!appId;

            const appData = {
                tujuan: document.getElementById('appTujuan').value,
                tarikhKeluar: document.getElementById('appTarikhKeluar').value,
                masaKeluar: document.getElementById('appMasaKeluar').value,
                tarikhKembali: document.getElementById('appTarikhKembali').value,
                masaKembali: document.getElementById('appMasaKembali').value,
                fileData: selectedFile ? selectedFile.fileData : null,
                fileName: selectedFile ? selectedFile.fileName : null
            };

            const payload = {
                action: isUpdate ? 'updatePermohonan' : 'createPermohonan',
                data: isUpdate ? { ...appData, id_permohonan: appId } : { ...appData, kodWaris: currentItem.kod_waris, namaPemohon: currentItem.nama_waris, namaAnak: currentItem.nama_anak }
            };

            try {
                await postData(payload);
                 setTimeout(async () => {
                    alert(`Permohonan berjaya ${isUpdate ? 'dikemaskini' : 'dihantar'}!`);
                    await refreshDataAndView();
                    switchView('results');
                }, 1500);
            } catch (err) {
                alert(`Gagal: ${err.message}`);
                setButtonLoading(appSubmitButton, false);
            }
        });

        searchForm.addEventListener('submit', async (e) => { e.preventDefault(); const kodWaris = kodWarisInput.value.trim(); if (!kodWaris) { statusMessage.textContent = 'Sila masukkan Kod Waris.'; return; } setButtonLoading(document.getElementById('searchButton'), true, 'Mencari...'); try { const data = await fetchData(); const foundItem = data.murid.find(item => item.kod_waris.toString().toLowerCase() === kodWaris.toLowerCase()); if (foundItem) { renderResults(foundItem); const filteredApps = data.permohonan.filter(app => app.kod_waris.toString() === foundItem.kod_waris.toString()); renderApplicationHistory(filteredApps); switchView('results'); } else { statusMessage.textContent = 'Kod Waris tidak ditemui. Sila cuba lagi.'; } } catch (err) { statusMessage.textContent = `Ralat: ${err.message}`; } finally { setButtonLoading(document.getElementById('searchButton'), false); } });
        
        updateForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const saveButton = document.getElementById('saveButton'); 
            setButtonLoading(saveButton, true, 'Menyimpan...'); 
            const updatedData = { kod_waris: currentItem.kod_waris, nama_waris: document.getElementById('namaWarisInput').value, email: document.getElementById('emailInput').value, no_telefon: document.getElementById('noTelefonInput').value, nama_anak: document.getElementById('namaAnakInput').value, jantina: document.getElementById('jantinaInput').value, tingkatan: document.getElementById('tingkatanInput').value, }; 
            try { 
                await postData({ action: 'update', data: updatedData }); 
                setTimeout(async () => {
                    renderResults(updatedData); 
                    allDataCache = null; 
                    alert('Maklumat berjaya dikemaskini!'); 
                    setEditMode(false); 
                }, 1500);
            } catch (err) { 
                alert(`Gagal mengemaskini: ${err.message}`); 
            } finally { 
                setButtonLoading(saveButton, false); 
            } 
        });

        document.getElementById('updateButton').addEventListener('click', () => setEditMode(true));
        document.getElementById('cancelButton').addEventListener('click', () => setEditMode(false));
        document.getElementById('cancelApplicationButton').addEventListener('click', () => switchView('results'));
        document.getElementById('backToSearchButton').addEventListener('click', () => { kodWarisInput.value = ''; statusMessage.textContent = 'Sila mulakan carian.'; switchView('search'); });
        
        document.addEventListener('DOMContentLoaded', () => {
            const datetimeEl = document.getElementById('datetime');
            function updateDateTime() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                datetimeEl.textContent = now.toLocaleDateString('ms-MY', options);
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        switchView('search');
    </script>
</body>
</html>
